<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>m | succinct, expressive and efficient programming</title>
		<script src="wasi.js"></script>
		<script src="mw.js"></script>
		<script src="zoom.js"></script>
		<link rel="stylesheet" href="simple.css">
		<link rel="stylesheet" href="style.css">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
	</head>
	<body>
		<header>
		<nav>
			<a href="/" class="current">M</a>
			<a href="/code/general.html">Code</a>
			<a href="/tutorial/general.html">Tutorials</a>
			<a href="/grammar.html">Grammar</a>
			<a href="https://github.com/ligangwang/m"><svg class="icon" viewBox="0 0 32 32">
					<path
						d="M16 0.395c-8.836 0-16 7.163-16 16 0 7.069 4.585 13.067 10.942 15.182 0.8 0.148 1.094-0.347 1.094-0.77 0-0.381-0.015-1.642-0.022-2.979-4.452 0.968-5.391-1.888-5.391-1.888-0.728-1.849-1.776-2.341-1.776-2.341-1.452-0.993 0.11-0.973 0.11-0.973 1.606 0.113 2.452 1.649 2.452 1.649 1.427 2.446 3.743 1.739 4.656 1.33 0.143-1.034 0.558-1.74 1.016-2.14-3.554-0.404-7.29-1.777-7.29-7.907 0-1.747 0.625-3.174 1.649-4.295-0.166-0.403-0.714-2.030 0.155-4.234 0 0 1.344-0.43 4.401 1.64 1.276-0.355 2.645-0.532 4.005-0.539 1.359 0.006 2.729 0.184 4.008 0.539 3.054-2.070 4.395-1.64 4.395-1.64 0.871 2.204 0.323 3.831 0.157 4.234 1.026 1.12 1.647 2.548 1.647 4.295 0 6.145-3.743 7.498-7.306 7.895 0.574 0.497 1.085 1.47 1.085 2.963 0 2.141-0.019 3.864-0.019 4.391 0 0.426 0.288 0.925 1.099 0.768 6.354-2.118 10.933-8.113 10.933-15.18 0-8.837-7.164-16-16-16z">
					</path>
				</svg>Github</a>
		</nav>
		</header>
		<textarea style="min-height: 300px; font-size:small;" autocomplete="off" id="code" wrap="logical" spellcheck="false"></textarea>
		<div style="width: 100%;">
			<button type="button" id="run" style="min-width: 70px;">run</button>
		</div>
		<div style="width: 100%;">
			<div><button id="backward" onclick="go_backward()" style="padding: 1px 5px 1px 5px;"><-</button>&nbsp;&nbsp;
				<button id="forward" onclick="go_forward()" style="padding: 1px 5px 1px 5px;">-></button>
			</div>
			<div id="canvas_container" style="display: inline-block; width: 390px; margin-right: 10px;">
				<canvas id="canvas" style="height: 300px; width: 400px; padding: 0em;"></canvas>
			</div>
			<div style="display: block; width: 390px; float: right;">
				<textarea style="min-height: 300px; width:100%; font-size:small;" id='console' readonly>
				</textarea>
			</div>
		</div>
		<script>
			var codeInput = document.getElementById("code");
			codeInput.addEventListener('keydown', function(e) {
			if (e.key == 'Tab') {
				e.preventDefault();
				var start = this.selectionStart;
				var end = this.selectionEnd;

				// set textarea value to: text before caret + tab + text after caret
				this.value = this.value.substring(0, start) +
				"\t" + this.value.substring(end);

				// put caret at right position again
				this.selectionStart =
				this.selectionEnd = start + 1;
			}
			});
			var backward = document.getElementById("backward");
			var forward = document.getElementById("forward");
			function go_backward()
			{
				zoom.backward();
			}
			function go_forward()
			{
				zoom.forward();
			}

			function update_back_forward()
			{
				backward.disabled = zoom.cur_pos <= 0;
				forward.disabled = zoom.cur_pos >= zoom.history.length - 1;
			}
			function onZoom(x0, y0, x1, y1)
			{
				instance.code_instance.exports.plot_mandelbrot_set(x0, y0, x1, y1);
				update_back_forward();
			}
			var zoom = initZoom(document.getElementById('canvas_container'), onZoom, -2.0, -1.2, 1.0, 1.2, 400, 300);
			update_back_forward();
	var code_text = 
`print "plot a mandelbrot set"

let plot_mandelbrot_set x0:f64 y0:f64 x1:f64 y1:f64 =
	let width = 400, height = 300
	var a:u8[height][width * 4]
	let scalex = (x1-x0)/width, scaley = (y1-y0)/height, max_iter = 510
	var v = 0.0, r = 0.0, g = 0.0, b = 0.0
	for x in 0..width
		for y in 0..height
			let cx = x0 + scalex*x
			let cy = y0 + scaley*y
			var zx = 0.0, zy = 0.0
			var zx2 = 0.0, zy2 = 0.0
			var n = 0
			while n<max_iter && (zx2 + zy2) < 4.0
				zy = 2.0 * zx * zy + cy
				zx = zx2  - zy2 + cx
				zx2 = zx * zx
				zy2 = zy * zy
				n++
			if n < max_iter then
				v = (log(n+1.5-(log2((log(zx2+zy2))/2.0))))/3.4
				if v < 1.0 then 
					r = v ** 4;g = v ** 2.5;b = v
				else
					v = v < 2.0 ? 2.0 - v : 0.0
					r = v;g = v ** 1.5;b = v ** 3.0
			a[y][4*x] = n == max_iter ? 0 : (u8)(r * 255)
			a[y][4*x+1] = n == max_iter ? 0 : (u8)(g * 255)
			a[y][4*x+2] = n == max_iter ? 0 : (u8)(b * 255)
			a[y][4*x+3] = 255

	setImageData a width height

plot_mandelbrot_set (-2.0) (-1.2) 1.0 1.2
`;
			codeInput.value = code_text;
					
			function set_image_data(data, width, height)
			{
				let canvas = document.getElementById('canvas');
				let ctx = canvas.getContext('2d');
				canvas.width = width;
				canvas.height = height;
				let imageData = ctx.createImageData(width, height);
				imageData.data.set(data);
				ctx.putImageData(imageData, 0, 0);
			}

			var instance = null;
			mw(new wasi(), '/mw.wasm', print, true, set_image_data).then(
				result=>{
					instance = result;
					print_version(instance.version);
				}
			);
			document.getElementById("run").addEventListener("click", run);
			function run(event) {
				clear();
				if(instance.code_bytes != undefined){
					instance.mw_instance.exports.free(instance.code_bytes);
				}
				let code = document.getElementById("code").value;
				let result = instance.run_code(code, release_wasm_memory=false);
				instance.code_bytes = result.code_bytes;
				instance.code_instance = result.code_instance;
				print(result.start_result);
				zoom.init();
				update_back_forward();
			}
			
			function print(text){
				if(text == null || text == undefined){
					return;
				}
				document.getElementById("console").textContent += text;
				// const ctx = document.getElementById('canvas').getContext('2d');
  				// ctx.font = '12px serif';
				// ctx.fillStyle = 'orange';
  				// ctx.fillText(text, 0, 30);
			}

			function clear(){
				document.getElementById("console").textContent = '';
				const ctx = document.getElementById('canvas').getContext('2d');
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			function print_version(version) {
				document.getElementById("version").textContent = version;
			}
		</script>
<footer>
	<label id="version"></label>
	<p>mlang is created by <a href="https://wangs.dev">Ligang Wang</a> and is open sourced under the MIT license.</p>
</footer>
	</body>
</html>