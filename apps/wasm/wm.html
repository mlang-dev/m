<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>m</title>
		<script src="term.js"></script>
		<script src="wm.js"></script>
		<script src="node_modules//binaryen/index.js"></script>
	</head>
	<body>
		<h1>m</h1>
		<br/>wm
		<div id='terminal'></div><br/>
		<br/>
		<script>
			var t = new Terminal('terminal')
			t.setHeight("600px")
			t.setWidth('800px')
			document.body.appendChild(t.html)

			var importObject = {
				wasi_snapshot_preview1: {
					fd_close : arg=>console.log("fd close: %s", arg),
					fd_seek : (arg1, arg2, arg3, arg4) => console.log("fd_seek: %s, %s, %s, %s", arg1, arg2, arg3, arg4),
					fd_write : (arg1, arg2, arg3, arg4) => console.log("fd_seek: %s, %s, %s, %s", arg1, arg2, arg3, arg4),
					proc_exit : arg=>console.log("proc_exit: %s", arg)
				}
			}
			WebAssembly.instantiateStreaming(fetch('wm.wasm'), importObject)
			.then(obj => {
				c_str = obj.instance.exports.version()
				t.print(to_js_str(obj.instance, c_str));
				obj.instance.exports.free_mem(c_str);

				t.input('', function (input) {
					let new_ptr = obj.instance.exports.alloc_mem(128)
					str_to_ab(obj.instance, input, new_ptr)

					let wat = obj.instance.exports.parse_code(new_ptr)
					t.print(to_js_str(obj.instance, wat))
					//t.print(run_wasm_code(binaryen.parseText(to_js_str(obj.instance, wat)).emitBinary()))
					obj.instance.exports.free_mem(wat)
				})
		});
		</script>

	</body>
</html>