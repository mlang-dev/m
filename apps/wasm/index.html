<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>m</title>
		<script src="term.js"></script>
		<script src="wm.js"></script>
	</head>
	<body>
		<h3>m expression</h3>
		<div id='terminal'></div><br/>
		<br/>
		<script>
			var t = new Terminal('terminal')
			t.setHeight("600px")
			t.setWidth('800px')
			document.body.appendChild(t.html)

			var importObject = {
				wasi_snapshot_preview1: {
					fd_close : arg=>console.log("fd close: %s", arg),
					fd_read : (arg1, arg2, arg3, arg4)=>console.log("fd_read %s, %s, %s, %s", arg1, arg2, arg3, arg4),
					fd_seek : (arg1, arg2, arg3, arg4) => console.log("fd_seek: %s, %s, %s, %s", arg1, arg2, arg3, arg4),
					fd_write : (arg1, arg2, arg3, arg4) => console.log("fd_seek: %s, %s, %s, %s", arg1, arg2, arg3, arg4),
					proc_exit : arg=>console.log("proc_exit: %s", arg),
					fd_fdstat_get: (arg0, arg1) => console.log("fd_fdstat_get: %s, %s", arg0, arg1)
				}
			}
			WebAssembly.instantiateStreaming(fetch('wm.wasm'), importObject)
			.then(obj => {
				c_str = obj.instance.exports.version()
				t.print(to_js_str(obj.instance, c_str));
				obj.instance.exports.free_mem(c_str);

				t.input('', function (input) {
					let new_ptr = obj.instance.exports.alloc_mem(128)
					str_to_ab(obj.instance, input, new_ptr)
					let wasm = obj.instance.exports.parse_expression(new_ptr)
					let wasm_size = obj.instance.exports.get_code_size();
					t.print(run_wasm_code(obj.instance, wasm, wasm_size));
					obj.instance.exports.free_mem(wasm);
				})
		});
		</script>

	</body>
</html>